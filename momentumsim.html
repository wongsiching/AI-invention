<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics Crash Lab - Triple Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Russo+One&family=Roboto:wght@400;500;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #111827; /* Darker bg */
            color: #e5e5e5;
            overflow: hidden;
        }

        h1, h2, .game-font {
            font-family: 'Russo One', sans-serif;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }

        /* Game Controls Panel */
        .control-panel {
            background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
            border-right: 1px solid #374151;
            box-shadow: 4px 0 20px rgba(0,0,0,0.6);
        }

        /* Inputs */
        .input-group {
            background: rgba(0,0,0,0.4);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 8px 10px;
            transition: all 0.2s;
            position: relative;
        }
        .input-group:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
        }
        
        /* Calculated Field Styling */
        .input-group.calculated {
            background: rgba(245, 158, 11, 0.1);
            border-color: #f59e0b;
        }
        .input-group.calculated label { color: #fbbf24; }
        .input-group.calculated input { color: #fbbf24; font-weight: bold; }
        
        /* --- BUTTON STYLES --- */
        .mode-btn {
            @apply flex-1 py-3 px-2 text-[10px] font-bold uppercase tracking-normal text-center cursor-pointer transition-all duration-200 flex flex-col items-center justify-center gap-1 relative overflow-hidden;
            border: none;
            border-radius: 6px;
            font-family: 'Russo One', sans-serif;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        /* Simulation Button Glow */
        .mode-btn.sim-active {
            background: linear-gradient(45deg, #3b82f6, #1e40af);
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3), 0 0 12px rgba(59, 130, 246, 0.6);
            transform: translateY(-1px);
            z-index: 10;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Calculator Button Glow */
        .mode-btn.calc-active {
            background: linear-gradient(45deg, #f59e0b, #b45309);
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3), 0 0 12px rgba(245, 158, 11, 0.6);
            transform: translateY(-1px);
            z-index: 10;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Game Button Glow */
        .mode-btn.game-active {
            background: linear-gradient(45deg, #8b5cf6, #5b21b6);
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3), 0 0 12px rgba(139, 92, 246, 0.6);
            transform: translateY(-1px);
            z-index: 10;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        /* Inactive State */
        .mode-btn.inactive {
            background: linear-gradient(180deg, #374151, #1f2937);
            color: #9ca3af;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
            border: 1px solid #4b5563;
            opacity: 0.8;
        }
        .mode-btn.inactive:hover {
            background: linear-gradient(180deg, #4b5563, #374151);
            color: #e5e5e5;
            opacity: 1;
        }

        /* --- DIVIDER STYLE --- */
        .tech-divider {
            display: flex; align-items: center; text-align: center; margin: 24px 0 20px 0; width: 100%;
        }
        .tech-divider::before, .tech-divider::after {
            content: ''; flex: 1; border-bottom: 1px solid #4b5563;
        }
        .tech-divider::before {
            margin-right: .5em; background: linear-gradient(to left, #4b5563, transparent); height: 1px; border: 0;
        }
        .tech-divider::after {
            margin-left: .5em; background: linear-gradient(to right, #4b5563, transparent); height: 1px; border: 0;
        }
        .tech-divider span {
            font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.15em; color: #9ca3af;
            font-weight: bold; background: #1f2937; padding: 4px 12px;
            border-radius: 99px; border: 1px solid #374151; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        input[type="number"] {
            background: transparent; color: white; font-family: 'Russo One', monospace; border: none; width: 100%; font-size: 1.1rem;
        }
        input[type="number"]:focus { outline: none; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* Action Button */
        .btn-game {
            background: linear-gradient(45deg, #ef4444, #b91c1c);
            border: none; border-radius: 6px; transition: all 0.2s;
            text-transform: uppercase; font-family: 'Russo One', sans-serif; letter-spacing: 1px;
            cursor: pointer; position: relative; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .btn-game:hover {
            transform: translateY(-2px); box-shadow: 0 8px 15px rgba(239, 68, 68, 0.4); filter: brightness(1.1);
        }
        .btn-game:active { transform: translateY(1px); }

        .btn-quiz {
            background: linear-gradient(45deg, #8b5cf6, #6d28d9);
        }
        .btn-quiz:hover { box-shadow: 0 8px 15px rgba(139, 92, 246, 0.4); }

        /* HUD Overlay */
        .hud-panel {
            background: rgba(17, 24, 39, 0.9); border: 1px solid #374151; backdrop-filter: blur(8px);
        }

        /* Math Formatting */
        .math-ctx { font-family: 'Times New Roman', Times, serif; font-size: 1.15em; line-height: 1.6; }
        .math-ctx i { font-family: 'Times New Roman', Times, serif; font-weight: normal; }
        .fraction { display: inline-block; vertical-align: middle; text-align: center; margin: 0 4px; }
        .fraction > .num { border-bottom: 1px solid #9ca3af; display: block; padding: 0 4px; font-size: 0.9em; }
        .fraction > .den { display: block; padding: 0 4px; font-size: 0.9em; }
        
        select {
            background: #1f2937; color: white; border: 1px solid #374151; padding: 10px;
            border-radius: 6px; width: 100%; font-size: 0.9rem; cursor: pointer; transition: border-color 0.2s;
        }
        select:hover { border-color: #6b7280; }
        select:focus { outline: none; border-color: #f59e0b; }

        /* Quiz Specifics */
        .quiz-option {
            background: #1f2937; border: 1px solid #374151; transition: all 0.2s;
        }
        .quiz-option:hover { background: #374151; border-color: #9ca3af; transform: translateY(-2px); }
        .quiz-correct { background: #065f46 !important; border-color: #34d399 !important; }
        .quiz-wrong { background: #7f1d1d !important; border-color: #f87171 !important; }
        
        @keyframes countdown {
            from { width: 100%; }
            to { width: 0%; }
        }
        .timer-bar {
            animation: countdown 60s linear forwards;
        }
    </style>
</head>
<body class="flex h-screen w-screen overflow-hidden text-gray-100">

    <!-- Left Controls Panel -->
    <aside class="control-panel w-96 flex flex-col z-20 overflow-hidden flex-shrink-0">
        
        <!-- Header -->
        <div class="p-6 pb-2">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-red-600 rounded-lg flex items-center justify-center shadow-lg shadow-orange-500/20">
                    <i class="fa-solid fa-car-burst text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl tracking-wider text-white leading-none">CRASH LAB</h1>
                    <div class="text-[10px] text-gray-500 font-bold tracking-[0.2em] mt-1">PHYSICS ENGINE</div>
                </div>
            </div>
            
            <!-- Modern Mode Switcher (Three Buttons) -->
            <div class="flex gap-2 mb-2">
                <div id="btn_sim" onclick="setMode('sim')" class="mode-btn sim-active group">
                    <i class="fa-solid fa-flask text-base mb-1 group-hover:scale-110 transition-transform text-blue-200"></i>
                    <span class="text-white">Simulate</span>
                    <span class="opacity-70 font-sans font-medium text-[9px] normal-case tracking-normal text-blue-100">Prediction</span>
                </div>
                <div id="btn_calc" onclick="setMode('calc')" class="mode-btn inactive group">
                    <i class="fa-solid fa-calculator text-base mb-1 group-hover:scale-110 transition-transform text-amber-200"></i>
                    <span class="text-white">Solver</span>
                    <span class="opacity-70 font-sans font-medium text-[9px] normal-case tracking-normal text-amber-100">Calculator</span>
                </div>
                <div id="btn_game" onclick="setMode('game')" class="mode-btn inactive group">
                    <i class="fa-solid fa-gamepad text-base mb-1 group-hover:scale-110 transition-transform text-purple-200"></i>
                    <span class="text-white">Quiz</span>
                    <span class="opacity-70 font-sans font-medium text-[9px] normal-case tracking-normal text-purple-100">Challenge</span>
                </div>
            </div>
        </div>

        <div class="overflow-y-auto flex-1 px-6 pb-6">

            <!-- MODE A: SIMULATION CONTROLS -->
            <div id="panel_sim" class="block animate-fade-in">
                <div class="mb-2">
                    <h2 class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-3 flex items-center">
                        <span class="w-1.5 h-1.5 bg-blue-500 rounded-full mr-2"></span>
                        1. Select Scenario
                    </h2>
                    <div class="grid gap-2">
                        <button onclick="setScenario('chasing')" class="bg-gray-800 hover:bg-gray-700 border border-gray-700 p-3 rounded-lg text-xs text-left w-full transition flex items-center group">
                            <div class="w-8 h-8 rounded bg-blue-900/30 text-blue-400 flex items-center justify-center mr-3 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                                <i class="fa-solid fa-flag-checkered"></i>
                            </div>
                            <span class="font-medium text-gray-300 group-hover:text-white">Speed Chase</span>
                        </button>
                        <button onclick="setScenario('stationary')" class="bg-gray-800 hover:bg-gray-700 border border-gray-700 p-3 rounded-lg text-xs text-left w-full transition flex items-center group">
                            <div class="w-8 h-8 rounded bg-green-900/30 text-green-400 flex items-center justify-center mr-3 group-hover:bg-green-600 group-hover:text-white transition-colors">
                                <i class="fa-solid fa-stop-circle"></i>
                            </div>
                            <span class="font-medium text-gray-300 group-hover:text-white">Rear End Collision</span>
                        </button>
                        <button onclick="setScenario('headon')" class="bg-gray-800 hover:bg-gray-700 border border-gray-700 p-3 rounded-lg text-xs text-left w-full transition flex items-center group">
                            <div class="w-8 h-8 rounded bg-red-900/30 text-red-400 flex items-center justify-center mr-3 group-hover:bg-red-600 group-hover:text-white transition-colors">
                                <i class="fa-solid fa-arrows-left-right-to-line"></i>
                            </div>
                            <span class="font-medium text-gray-300 group-hover:text-white">Head-On Impact</span>
                        </button>
                    </div>
                </div>

                <div class="tech-divider"><span>INPUT DATA PARAMETERS</span></div>

                <div class="mb-6">
                    <h2 class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-3 flex items-center">
                        <span class="w-1.5 h-1.5 bg-blue-500 rounded-full mr-2"></span>
                        2. Initial Conditions
                    </h2>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-3 bg-gray-800/50 rounded-xl border border-blue-500/20">
                            <div class="text-[10px] text-blue-400 font-bold uppercase tracking-wide mb-2 flex justify-between">Blue Car</div>
                            <div class="space-y-2">
                                <div><label class="text-[9px] text-gray-500 uppercase font-bold">Mass (kg)</label><input type="number" id="sim_m1" value="1000" class="bg-gray-900 rounded px-2 py-1 text-sm border border-gray-700"></div>
                                <div><label class="text-[9px] text-gray-500 uppercase font-bold">Velocity (m/s)</label><input type="number" id="sim_v1" value="20" class="bg-gray-900 rounded px-2 py-1 text-sm border border-gray-700"></div>
                            </div>
                        </div>
                        <div class="p-3 bg-gray-800/50 rounded-xl border border-red-500/20">
                            <div class="text-[10px] text-red-400 font-bold uppercase tracking-wide mb-2 flex justify-between">Red Truck</div>
                            <div class="space-y-2">
                                <div><label class="text-[9px] text-gray-500 uppercase font-bold">Mass (kg)</label><input type="number" id="sim_m2" value="1500" class="bg-gray-900 rounded px-2 py-1 text-sm border border-gray-700"></div>
                                <div><label class="text-[9px] text-gray-500 uppercase font-bold">Velocity (m/s)</label><input type="number" id="sim_v2" value="0" class="bg-gray-900 rounded px-2 py-1 text-sm border border-gray-700"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-6 p-4 bg-gradient-to-r from-orange-900/10 to-transparent border-l-2 border-orange-500 rounded-r-lg">
                    <h2 class="text-xs text-orange-400 font-bold uppercase tracking-widest mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-crosshairs"></i> 3. Prediction
                    </h2>
                    <div class="input-group border-orange-500/30 bg-orange-900/10">
                        <label class="block text-[10px] text-orange-300 font-bold uppercase mb-1">Target Final Velocity (v1)</label>
                        <div class="flex items-baseline">
                            <input type="number" id="sim_v1_target" value="8" class="text-xl text-orange-400 font-bold">
                            <span class="text-xs text-gray-500 ml-1">m/s</span>
                        </div>
                    </div>
                </div>
                
                <button id="mainBtnSim" onclick="toggleSim()" class="btn-game w-full py-4 text-xl shadow-lg relative overflow-hidden group mt-6">
                    <span class="relative z-10 flex items-center justify-center gap-2" id="btnTextSim"><i class="fa-solid fa-play"></i> RUN SIMULATION</span>
                </button>
            </div>

            <!-- MODE B: CALCULATOR CONTROLS -->
            <div id="panel_calc" class="hidden animate-fade-in">
                <div class="mb-2">
                    <h2 class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-3 flex items-center">
                        <span class="w-1.5 h-1.5 bg-amber-500 rounded-full mr-2"></span>
                        1. Load Preset
                    </h2>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="setProblem('find_v2')" class="bg-gray-800 hover:bg-gray-700 p-2 rounded text-[10px] text-left transition text-gray-300 border border-gray-700">Standard Crash</button>
                        <button onclick="setProblem('find_u1')" class="bg-gray-800 hover:bg-gray-700 p-2 rounded text-[10px] text-left transition text-gray-300 border border-gray-700">Find Initial U1</button>
                        <button onclick="setProblem('find_m2')" class="bg-gray-800 hover:bg-gray-700 p-2 rounded text-[10px] text-left transition text-gray-300 border border-gray-700">Mystery Mass</button>
                        <button onclick="setProblem('recoil')" class="bg-gray-800 hover:bg-gray-700 p-2 rounded text-[10px] text-left transition text-gray-300 border border-gray-700">Recoil/Explosion</button>
                    </div>
                </div>

                <div class="mb-6 p-4 bg-gray-800/50 rounded-lg border border-gray-700 mt-4">
                    <h2 class="text-xs text-amber-500 font-bold uppercase tracking-widest mb-2">2. Solve For</h2>
                    <select id="unknownSelector" onchange="updateSolverMode()">
                        <option value="v2">Final Velocity Red (v2)</option>
                        <option value="v1">Final Velocity Blue (v1)</option>
                        <option value="u1">Initial Velocity Blue (u1)</option>
                        <option value="u2">Initial Velocity Red (u2)</option>
                        <option value="m1">Mass Blue (m1)</option>
                        <option value="m2">Mass Red (m2)</option>
                    </select>
                </div>

                <div class="tech-divider"><span>INPUT PARAMETERS</span></div>

                <div class="space-y-4 mb-4">
                    <div class="pl-3 border-l-2 border-blue-500">
                        <h3 class="text-[10px] font-bold text-blue-400 uppercase tracking-wider mb-2">Blue Car (Obj 1)</h3>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="input-group" id="grp_calc_m1"><label class="block text-[8px] uppercase font-bold text-gray-500">Mass</label><input type="number" id="calc_m1" value="1000" oninput="solve()"></div>
                            <div class="input-group" id="grp_calc_u1"><label class="block text-[8px] uppercase font-bold text-gray-500">Init</label><input type="number" id="calc_u1" value="20" oninput="solve()"></div>
                            <div class="input-group" id="grp_calc_v1"><label class="block text-[8px] uppercase font-bold text-gray-500">Final</label><input type="number" id="calc_v1" value="10" oninput="solve()"></div>
                        </div>
                    </div>
                    <div class="pl-3 border-l-2 border-red-500">
                        <h3 class="text-[10px] font-bold text-red-400 uppercase tracking-wider mb-2">Red Truck (Obj 2)</h3>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="input-group" id="grp_calc_m2"><label class="block text-[8px] uppercase font-bold text-gray-500">Mass</label><input type="number" id="calc_m2" value="1500" oninput="solve()"></div>
                            <div class="input-group" id="grp_calc_u2"><label class="block text-[8px] uppercase font-bold text-gray-500">Init</label><input type="number" id="calc_u2" value="0" oninput="solve()"></div>
                            <div class="input-group" id="grp_calc_v2"><label class="block text-[8px] uppercase font-bold text-gray-500">Final</label><input type="number" id="calc_v2" value="0" oninput="solve()"></div>
                        </div>
                    </div>
                </div>
                
                <button id="mainBtnCalc" onclick="toggleSim()" class="btn-game w-full py-4 text-xl shadow-lg relative overflow-hidden group mt-6">
                    <span class="relative z-10 flex items-center justify-center gap-2" id="btnTextCalc"><i class="fa-solid fa-play"></i> RUN SIMULATION</span>
                </button>
            </div>

            <!-- MODE C: GAME CONTROLS -->
            <div id="panel_game" class="hidden animate-fade-in">
                <div class="p-4 bg-purple-900/20 border border-purple-500/30 rounded-xl mb-6">
                    <h2 class="text-sm text-purple-400 font-bold uppercase tracking-widest mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-trophy"></i> CHALLENGE MODE
                    </h2>
                    <p class="text-xs text-gray-400 leading-relaxed mb-4">
                        Test your physics skills! You have 60 seconds to answer 10 AI-generated momentum questions.
                    </p>
                    <div class="grid grid-cols-2 gap-2 text-center">
                        <div class="bg-gray-800 p-2 rounded">
                            <div class="text-xs text-gray-500 uppercase">Questions</div>
                            <div class="text-xl font-mono font-bold text-white">10</div>
                        </div>
                        <div class="bg-gray-800 p-2 rounded">
                            <div class="text-xs text-gray-500 uppercase">Time Limit</div>
                            <div class="text-xl font-mono font-bold text-white">60s</div>
                        </div>
                    </div>
                </div>

                <div class="tech-divider"><span>READY?</span></div>

                <button onclick="startGame()" class="btn-game btn-quiz w-full py-6 text-xl shadow-lg relative overflow-hidden group mt-6">
                    <span class="relative z-10 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-rocket"></i> START GAME
                    </span>
                </button>
            </div>

            <!-- Reset Button (Shared) -->
            <button onclick="resetSim()" class="mt-4 w-full text-[10px] text-gray-500 hover:text-white uppercase tracking-wider transition-colors flex items-center justify-center gap-1">
                <i class="fa-solid fa-rotate-right"></i> Reset System
            </button>
        </div>
    </aside>

    <!-- Main Game View -->
    <main class="flex-1 relative bg-gray-900 flex flex-col">
        
        <!-- Canvas Layer -->
        <div id="canvasWrapper" class="absolute inset-0 bg-gray-900">
            <canvas id="gameCanvas" class="w-full h-full block"></canvas>
            <div class="absolute inset-0 pointer-events-none opacity-5" style="background-image: linear-gradient(#4b5563 1px, transparent 1px), linear-gradient(90deg, #4b5563 1px, transparent 1px); background-size: 40px 40px;"></div>
        </div>

        <!-- HUD Layer (Overlays) -->
        <div id="simulationHUD" class="absolute top-0 left-0 w-full p-6 pointer-events-none flex justify-between items-start z-10">
            <!-- P1 Stats -->
            <div class="hud-panel p-4 rounded-xl border-l-4 border-blue-500 w-52 shadow-2xl">
                <div class="text-[10px] text-blue-400 uppercase font-bold mb-1 tracking-wider">Blue Momentum</div>
                <div class="text-3xl game-font text-white" id="hud_p1">0</div>
                <div class="text-[10px] text-gray-500 font-mono">kg·m/s</div>
            </div>
            <!-- P2 Stats -->
            <div class="hud-panel p-4 rounded-xl border-r-4 border-red-500 w-52 text-right shadow-2xl">
                <div class="text-[10px] text-red-400 uppercase font-bold mb-1 tracking-wider">Red Momentum</div>
                <div class="text-3xl game-font text-white" id="hud_p2">0</div>
                <div class="text-[10px] text-gray-500 font-mono">kg·m/s</div>
            </div>
        </div>

        <!-- Report Panel (Sim/Calc Mode) -->
        <div id="reportPanel" class="hud-panel p-8 rounded-2xl border border-gray-700 text-center transform translate-y-[-200%] transition-transform duration-500 ease-out pointer-events-auto shadow-2xl bg-gray-900/95 max-w-4xl w-full mx-auto absolute left-0 right-0 top-24 z-50 overflow-y-auto max-h-[80vh]">
            <div class="flex justify-between items-start mb-6 border-b border-gray-700 pb-4">
                <div class="text-left">
                    <div class="text-amber-500 uppercase text-[10px] font-bold tracking-[0.3em] mb-1">Mission Report</div>
                    <h2 class="text-3xl text-white font-bold tracking-tight" id="reportTitle">ANALYSIS COMPLETE</h2>
                </div>
                <div id="feasibilityBadge" class="px-4 py-2 rounded-lg text-xs font-bold bg-gray-800 text-gray-400 border border-gray-700">--</div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8 text-left">
                <div class="bg-gray-950 p-6 rounded-xl border border-gray-800 text-gray-300 overflow-x-auto math-ctx shadow-inner">
                    <h3 class="text-amber-500 font-sans uppercase mb-4 text-[10px] font-bold tracking-widest flex items-center"><i class="fa-solid fa-terminal mr-2"></i> Physics Engine Log</h3>
                    <div id="solverLog" class="space-y-4 text-sm leading-relaxed"></div>
                </div>
                <div class="space-y-4 font-sans">
                     <div class="bg-gray-800/50 p-5 rounded-xl border border-gray-700">
                        <h3 class="text-xs text-gray-400 font-bold uppercase mb-3 tracking-wider">Energy Analysis (ΔKE)</h3>
                        <div class="flex justify-between items-end mb-2">
                            <span class="text-gray-400 text-sm">Total Kinetic Energy Change</span>
                            <span class="font-mono text-2xl text-white font-bold" id="rep_ke">0 J</span>
                        </div>
                        <div class="h-1 w-full bg-gray-700 rounded-full overflow-hidden mb-2">
                            <div id="energyBar" class="h-full bg-blue-500 w-0 transition-all duration-1000"></div>
                        </div>
                        <div class="text-[10px] text-gray-500 text-right uppercase tracking-wider font-bold" id="energy_note">--</div>
                    </div>
                    <div class="bg-gray-800/50 p-5 rounded-xl border border-gray-700">
                        <h3 class="text-xs text-gray-400 font-bold uppercase mb-3 tracking-wider">Velocity Delta (m/s)</h3>
                        <table class="w-full text-sm text-left">
                            <thead class="text-[10px] text-gray-500 uppercase border-b border-gray-700 font-bold"><tr><th class="pb-2 pl-2">Vehicle</th><th class="pb-2 text-right">Initial (u)</th><th class="pb-2 text-right pr-2">Final (v)</th></tr></thead>
                            <tbody class="font-mono">
                                <tr class="border-b border-gray-700/50"><td class="py-3 pl-2 text-blue-400 font-bold">Blue</td><td class="py-3 text-right text-gray-400" id="tbl_u1">0</td><td class="py-3 text-right pr-2 text-white font-bold" id="tbl_v1">0</td></tr>
                                <tr><td class="py-3 pl-2 text-red-400 font-bold">Red</td><td class="py-3 text-right text-gray-400" id="tbl_u2">0</td><td class="py-3 text-right pr-2 text-white font-bold" id="tbl_v2">0</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="flex justify-end">
                <button onclick="resetSim()" class="px-8 py-3 bg-white text-gray-900 hover:bg-gray-200 transition-colors uppercase text-xs font-bold tracking-widest rounded shadow-lg flex items-center gap-2"><i class="fa-solid fa-rotate-left"></i> Reset & Replay</button>
            </div>
        </div>

        <!-- GAME MODE INTERFACE -->
        <div id="gameInterface" class="hidden absolute inset-0 bg-gray-900/95 z-50 flex flex-col items-center justify-start pt-10 md:justify-center md:pt-0 p-8 backdrop-blur-sm overflow-y-auto">
            
            <!-- Game HUD -->
            <div class="w-full max-w-3xl flex justify-between items-center mb-8 flex-shrink-0">
                <div class="text-left">
                    <div class="text-[10px] md:text-xs text-gray-500 uppercase tracking-widest font-bold mb-1">SCORE</div>
                    <div class="text-2xl md:text-4xl font-mono text-purple-400 font-bold"><span id="gameScore">0</span><span class="text-gray-600 text-lg md:text-2xl">/10</span></div>
                </div>
                <div class="text-center">
                    <div class="w-16 h-16 md:w-20 md:h-20 rounded-full border-4 border-purple-500 flex items-center justify-center bg-gray-800 shadow-[0_0_20px_rgba(168,85,247,0.4)]">
                        <span id="gameTimer" class="text-2xl md:text-3xl font-mono font-bold text-white">60</span>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] md:text-xs text-gray-500 uppercase tracking-widest font-bold mb-1">QUESTION</div>
                    <div class="text-2xl md:text-4xl font-mono text-white font-bold"><span id="gameQNum">1</span><span class="text-gray-600 text-lg md:text-2xl">/10</span></div>
                </div>
            </div>

            <!-- Question Card -->
            <div class="w-full max-w-3xl bg-gray-800 p-6 md:p-8 rounded-2xl border border-gray-700 shadow-2xl mb-8 relative overflow-hidden flex-shrink-0">
                <!-- Timer Bar -->
                <div class="absolute top-0 left-0 h-1 bg-purple-600 timer-bar" id="progressBar"></div>
                
                <h3 class="text-xs text-purple-400 font-bold uppercase tracking-widest mb-4">Physics AI Question Generator</h3>
                <p id="questionText" class="text-xl md:text-2xl text-white font-medium leading-relaxed break-words">
                    Generating question...
                </p>
            </div>

            <!-- Options -->
            <div id="optionsGrid" class="w-full max-w-3xl grid grid-cols-1 md:grid-cols-2 gap-4 pb-10">
                <button class="quiz-option p-4 md:p-6 rounded-xl text-lg md:text-xl font-bold text-gray-300 text-left"></button>
                <button class="quiz-option p-4 md:p-6 rounded-xl text-lg md:text-xl font-bold text-gray-300 text-left"></button>
                <button class="quiz-option p-4 md:p-6 rounded-xl text-lg md:text-xl font-bold text-gray-300 text-left"></button>
                <button class="quiz-option p-4 md:p-6 rounded-xl text-lg md:text-xl font-bold text-gray-300 text-left"></button>
            </div>

            <!-- Game Over Screen -->
            <div id="gameOverScreen" class="hidden absolute inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center text-center">
                <div class="text-purple-500 text-6xl mb-4"><i class="fa-solid fa-flag-checkered"></i></div>
                <h2 class="text-5xl font-bold text-white mb-2 font-mono">GAME OVER</h2>
                <div class="text-xl text-gray-400 mb-8 uppercase tracking-widest">Final Score: <span id="finalScore" class="text-white font-bold">0</span></div>
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 max-w-md w-full mb-8">
                    <div class="text-xs text-gray-500 uppercase tracking-widest mb-2">Performance Rank</div>
                    <div id="finalRank" class="text-3xl text-purple-400 font-bold">Beginner Physics</div>
                </div>
                <button onclick="startGame()" class="px-10 py-4 bg-white text-black font-bold uppercase tracking-widest rounded hover:bg-gray-200 transition">Play Again</button>
                <button onclick="setMode('sim')" class="mt-4 text-gray-500 hover:text-white text-sm uppercase tracking-wider">Return to Lab</button>
            </div>
        </div>

    </main>

    <script>
        // --- Game Engine ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const wrapper = document.getElementById('canvasWrapper');

        const state = {
            mode: 'sim', 
            // Physics Data
            m1: 1000, u1: 20, v1: 0, m2: 1500, u2: 0, v2: 0,
            v1_target: 8, unknown: 'v2',
            // Visuals
            x1: 0, x2: 0, currV1: 0, currV2: 0, scale: 20, offsetY: 0, 
            isPlaying: false, hasCollided: false, shakeTime: 0, particles: []
        };

        // --- QUIZ STATE ---
        let quizState = {
            active: false,
            score: 0,
            qIndex: 0,
            timeLeft: 60,
            timerId: null,
            currentQ: null
        };

        let animId;
        let lastTime = 0;

        function init() {
            window.addEventListener('resize', resize);
            resize();
            setMode('sim');
            setScenario('chasing');
        }

        function resize() {
            canvas.width = wrapper.clientWidth;
            canvas.height = wrapper.clientHeight;
            state.offsetY = canvas.height * 0.65;
            draw();
        }

        // --- Mode Switching ---
        function setMode(mode) {
            state.mode = mode;
            resetSim();
            clearInterval(quizState.timerId); // Stop any game timers

            // UI Toggles
            document.getElementById('panel_sim').className = mode === 'sim' ? 'block animate-fade-in' : 'hidden';
            document.getElementById('panel_calc').className = mode === 'calc' ? 'block animate-fade-in' : 'hidden';
            document.getElementById('panel_game').className = mode === 'game' ? 'block animate-fade-in' : 'hidden';
            
            // Buttons
            document.getElementById('btn_sim').className = `mode-btn ${mode === 'sim' ? 'sim-active' : 'inactive'} group`;
            document.getElementById('btn_calc').className = `mode-btn ${mode === 'calc' ? 'calc-active' : 'inactive'} group`;
            document.getElementById('btn_game').className = `mode-btn ${mode === 'game' ? 'game-active' : 'inactive'} group`;

            // HUD Visibility
            const isGame = mode === 'game';
            document.getElementById('simulationHUD').style.display = isGame ? 'none' : 'flex';
            document.getElementById('gameInterface').className = 'hidden'; // Hide initially, show via startGame
            document.getElementById('gameCanvas').style.opacity = isGame ? '0.3' : '1';

            if(mode === 'calc') { updateSolverMode(); solve(); }
        }

        // --- QUIZ LOGIC ---
        function startGame() {
            quizState = { active: true, score: 0, qIndex: 0, timeLeft: 60, timerId: null, currentQ: null };
            document.getElementById('gameInterface').className = 'absolute inset-0 bg-gray-900/95 z-50 flex flex-col items-center justify-start pt-10 md:justify-center md:pt-0 p-8 backdrop-blur-sm overflow-y-auto animate-fade-in';
            document.getElementById('gameOverScreen').className = 'hidden';
            updateGameUI();
            nextQuestion();
            quizState.timerId = setInterval(gameTick, 1000);
        }

        function gameTick() {
            quizState.timeLeft--;
            updateGameUI();
            if(quizState.timeLeft <= 0) endGame();
        }

        function nextQuestion() {
            if(quizState.qIndex >= 10) { endGame(); return; }
            quizState.qIndex++;
            quizState.currentQ = generateMathQuestion();
            
            // UI Update
            document.getElementById('questionText').innerText = quizState.currentQ.text;
            const btns = document.getElementById('optionsGrid').children;
            
            // Reset styles
            for(let i=0; i<4; i++) {
                btns[i].className = "quiz-option p-4 md:p-6 rounded-xl text-lg md:text-xl font-bold text-gray-300 text-left";
                btns[i].innerText = quizState.currentQ.options[i];
                btns[i].onclick = () => checkAnswer(i, btns[i]);
                btns[i].disabled = false;
            }
            updateGameUI();
            
            // Reset Progress Bar Animation
            const bar = document.getElementById('progressBar');
            bar.style.animation = 'none';
            bar.offsetHeight; /* trigger reflow */
            bar.style.animation = `countdown ${quizState.timeLeft}s linear forwards`;
        }

        function checkAnswer(idx, btnElement) {
            const correct = idx === quizState.currentQ.correctIndex;
            const btns = document.getElementById('optionsGrid').children;
            
            // Lock buttons
            for(let b of btns) b.disabled = true;

            if(correct) {
                btnElement.className += " quiz-correct";
                quizState.score++;
                // Sound effect visual
            } else {
                btnElement.className += " quiz-wrong";
                // Highlight correct
                btns[quizState.currentQ.correctIndex].className += " quiz-correct";
            }

            setTimeout(nextQuestion, 1000);
        }

        function endGame() {
            clearInterval(quizState.timerId);
            document.getElementById('gameOverScreen').className = 'absolute inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center text-center animate-fade-in';
            document.getElementById('finalScore').innerText = `${quizState.score}/10`;
            
            let rank = "Student Driver";
            if(quizState.score >= 9) rank = "Isaac Newton Reincarnate";
            else if(quizState.score >= 7) rank = "Physics Professor";
            else if(quizState.score >= 5) rank = "Lab Assistant";
            else if(quizState.score >= 3) rank = "Crash Test Dummy";
            
            document.getElementById('finalRank').innerText = rank;
        }

        function updateGameUI() {
            document.getElementById('gameScore').innerText = quizState.score;
            document.getElementById('gameQNum').innerText = quizState.qIndex;
            document.getElementById('gameTimer').innerText = quizState.timeLeft;
            if(quizState.timeLeft < 10) document.getElementById('gameTimer').className = "text-2xl md:text-3xl font-mono font-bold text-red-500 animate-pulse";
            else document.getElementById('gameTimer').className = "text-2xl md:text-3xl font-mono font-bold text-white";
        }

        function generateMathQuestion() {
            const types = ['p', 'v', 'cons_inelastic'];
            const type = types[Math.floor(Math.random() * types.length)];
            
            let m1 = Math.floor(Math.random()*20 + 1) * 100; // 100-2000
            let u1 = Math.floor(Math.random()*20 + 5); // 5-25
            
            let qText, ans, unit;

            if (type === 'p') {
                qText = `A blue car has a mass of ${m1} kg and travels at ${u1} m/s. What is its momentum?`;
                ans = m1 * u1;
                unit = "kg·m/s";
            } else if (type === 'v') {
                let p = m1 * u1;
                qText = `A truck has momentum of ${p} kg·m/s and mass of ${m1} kg. What is its velocity?`;
                ans = u1;
                unit = "m/s";
            } else {
                let m2 = m1; 
                let u2 = 0;
                qText = `A ${m1}kg car moving at ${u1}m/s crashes into a stationary ${m2}kg car. They stick together. What is the final velocity?`;
                // m1u1 = (m1+m2)v => v = m1u1 / (m1+m2)
                ans = (m1*u1) / (m1+m2);
                unit = "m/s";
            }

            // Generate Options
            let options = [ans];
            while(options.length < 4) {
                let fake = ans * (0.5 + Math.random());
                if(Math.random() > 0.5) fake = ans + Math.floor(Math.random()*10 + 1);
                fake = parseFloat(fake.toFixed(1));
                if(!options.includes(fake)) options.push(fake);
            }
            // Shuffle
            options = options.sort(() => Math.random() - 0.5);
            
            // Format
            const correctIndex = options.indexOf(parseFloat(ans.toFixed(1))) !== -1 ? options.indexOf(parseFloat(ans.toFixed(1))) : options.indexOf(ans);
            // Fix float precision for display
            const displayOptions = options.map(o => Number.isInteger(o) ? o + " " + unit : o.toFixed(1) + " " + unit);

            return {
                text: qText,
                options: displayOptions,
                correctIndex: correctIndex
            };
        }

        // --- SIM/CALC LOGIC (Preserved) ---
        function setScenario(type) {
            resetSim();
            if (type === 'chasing') {
                document.getElementById('sim_m1').value = 1200; document.getElementById('sim_v1').value = 25;
                document.getElementById('sim_m2').value = 1200; document.getElementById('sim_v2').value = 10;
                document.getElementById('sim_v1_target').value = 17.5;
            } else if (type === 'stationary') {
                document.getElementById('sim_m1').value = 1500; document.getElementById('sim_v1').value = 20;
                document.getElementById('sim_m2').value = 1000; document.getElementById('sim_v2').value = 0;
                document.getElementById('sim_v1_target').value = 12;
            } else if (type === 'headon') {
                document.getElementById('sim_m1').value = 1200; document.getElementById('sim_v1').value = 15;
                document.getElementById('sim_m2').value = 1200; document.getElementById('sim_v2').value = -15;
                document.getElementById('sim_v1_target').value = 0;
            }
            readSimInputs();
            setupPositions();
            draw();
        }

        function readSimInputs() {
            state.m1 = parseFloat(document.getElementById('sim_m1').value);
            state.u1 = parseFloat(document.getElementById('sim_v1').value);
            state.m2 = parseFloat(document.getElementById('sim_m2').value);
            state.u2 = parseFloat(document.getElementById('sim_v2').value);
            state.v1_target = parseFloat(document.getElementById('sim_v1_target').value);
        }

        function setProblem(type) {
            const sel = document.getElementById('unknownSelector');
            if (type === 'find_v2') {
                sel.value = 'v2'; setCalcInput('m1', 1000); setCalcInput('u1', 20); setCalcInput('v1', 5); setCalcInput('m2', 1500); setCalcInput('u2', 0);
            } else if (type === 'find_u1') {
                sel.value = 'u1'; setCalcInput('m1', 1200); setCalcInput('v1', 0); setCalcInput('m2', 1000); setCalcInput('u2', 0); setCalcInput('v2', 20);
            } else if (type === 'find_m2') {
                sel.value = 'm2'; setCalcInput('m1', 2000); setCalcInput('u1', 10); setCalcInput('v1', 2); setCalcInput('u2', 0); setCalcInput('v2', 8);
            } else if (type === 'recoil') {
                sel.value = 'v1'; setCalcInput('m1', 5000); setCalcInput('u1', 0); setCalcInput('m2', 50); setCalcInput('u2', 0); setCalcInput('v2', 400);
            }
            updateSolverMode(); solve();
        }

        function setCalcInput(id, val) { document.getElementById('calc_'+id).value = val; }

        function updateSolverMode() {
            state.unknown = document.getElementById('unknownSelector').value;
            ['m1','u1','v1','m2','u2','v2'].forEach(id => {
                document.getElementById('grp_calc_' + id).classList.remove('calculated');
                document.getElementById('calc_' + id).disabled = false;
            });
            document.getElementById('grp_calc_' + state.unknown).classList.add('calculated');
            document.getElementById('calc_' + state.unknown).disabled = true;
        }

        function solve() {
            if (state.mode !== 'calc' || state.isPlaying) return;
            const v = {
                m1: parseFloat(document.getElementById('calc_m1').value), u1: parseFloat(document.getElementById('calc_u1').value), v1: parseFloat(document.getElementById('calc_v1').value),
                m2: parseFloat(document.getElementById('calc_m2').value), u2: parseFloat(document.getElementById('calc_u2').value), v2: parseFloat(document.getElementById('calc_v2').value)
            };
            let result = 0;
            try {
                switch(state.unknown) {
                    case 'v2': result = (v.m1*v.u1 + v.m2*v.u2 - v.m1*v.v1) / v.m2; break;
                    case 'v1': result = (v.m1*v.u1 + v.m2*v.u2 - v.m2*v.v2) / v.m1; break;
                    case 'u1': result = (v.m1*v.v1 + v.m2*v.v2 - v.m2*v.u2) / v.m1; break;
                    case 'u2': result = (v.m1*v.v1 + v.m2*v.v2 - v.m1*v.u1) / v.m2; break;
                    case 'm1': result = (v.m2 * (v.v2 - v.u2)) / (v.u1 - v.v1); break;
                    case 'm2': result = (v.m1 * (v.v1 - v.u1)) / (v.u2 - v.v2); break;
                }
            } catch(e) { result = NaN; }

            if (!isNaN(result) && isFinite(result)) {
                document.getElementById('calc_' + state.unknown).value = Number.isInteger(result) ? result : result.toFixed(2);
                state.m1=v.m1; state.u1=v.u1; state.v1=v.v1; state.m2=v.m2; state.u2=v.u2; state.v2=v.v2;
                state[state.unknown] = result;
            }
            setupPositions(); draw();
        }

        function setupPositions() {
            if (state.u1 > state.u2) { state.x1 = -7; state.x2 = 5; } else { state.x1 = -5; state.x2 = 7; }
            state.currV1 = state.u1; state.currV2 = state.u2;
        }

        function toggleSim() {
            if (state.isPlaying) {
                state.isPlaying = false; cancelAnimationFrame(animId);
                const icon = '<i class="fa-solid fa-play"></i> RESUME';
                if(state.mode==='sim') document.getElementById('btnTextSim').innerHTML = icon;
                else document.getElementById('btnTextCalc').innerHTML = icon;
            } else {
                if (state.mode === 'sim') {
                    readSimInputs();
                    const P_total = state.m1*state.u1 + state.m2*state.u2;
                    state.v1 = state.v1_target;
                    state.v2 = (P_total - state.m1*state.v1) / state.m2;
                } else { solve(); }

                document.querySelectorAll('input').forEach(i => i.disabled = true);
                state.isPlaying = true;
                const icon = '<i class="fa-solid fa-spinner fa-spin"></i> RUNNING...';
                if(state.mode==='sim') document.getElementById('btnTextSim').innerHTML = icon;
                else document.getElementById('btnTextCalc').innerHTML = icon;
                
                lastTime = performance.now(); loop(lastTime);
            }
        }

        function resetSim() {
            state.isPlaying = false; state.hasCollided = false; state.particles = []; cancelAnimationFrame(animId);
            document.querySelectorAll('input').forEach(i => i.disabled = false);
            if(state.mode==='calc') updateSolverMode();
            document.getElementById('reportPanel').style.transform = "translateY(-200%)";
            const icon = '<i class="fa-solid fa-play"></i> RUN SIMULATION';
            if(document.getElementById('btnTextSim')) document.getElementById('btnTextSim').innerHTML = icon;
            if(document.getElementById('btnTextCalc')) document.getElementById('btnTextCalc').innerHTML = icon;
            if(state.mode === 'sim') readSimInputs(); else if(state.mode==='calc') solve();
            setupPositions(); draw(); updateHUD();
        }

        function loop(timestamp) {
            if (!state.isPlaying) return;
            const dt = Math.min((timestamp - lastTime) / 1000, 0.05); lastTime = timestamp;
            state.x1 += state.currV1 * dt; state.x2 += state.currV2 * dt;
            const carWidth = 3.5; const dist = state.x2 - state.x1;
            if (!state.hasCollided && dist <= carWidth) { if (state.currV1 > state.currV2) triggerCollision(); }
            updateParticles(dt); draw(); updateHUD();
            if (state.shakeTime > 0) { state.shakeTime -= dt; const s = (Math.random()-0.5)*10; wrapper.style.transform = `translate(${s}px, ${s}px)`; } 
            else { wrapper.style.transform = `none`; }
            animId = requestAnimationFrame(loop);
        }

        function triggerCollision() {
            state.hasCollided = true; state.shakeTime = 0.3;
            state.currV1 = state.v1; state.currV2 = state.v2;
            const center = (state.x1 + state.x2) / 2; state.x1 = center - 1.8; state.x2 = center + 1.8;
            spawnExplosion(center * state.scale + canvas.width/2, state.offsetY - 30);
            showReport();
        }

        function showReport() {
            const KE_i = 0.5*state.m1*state.u1**2 + 0.5*state.m2*state.u2**2;
            const KE_f = 0.5*state.m1*state.v1**2 + 0.5*state.m2*state.v2**2;
            const diff = KE_f - KE_i;
            const badge = document.getElementById('feasibilityBadge'); const note = document.getElementById('energy_note');
            const log = document.getElementById('solverLog'); const energyBar = document.getElementById('energyBar');

            document.getElementById('tbl_u1').innerText = state.u1.toFixed(1); document.getElementById('tbl_v1').innerText = state.v1.toFixed(1);
            document.getElementById('tbl_u2').innerText = state.u2.toFixed(1); document.getElementById('tbl_v2').innerText = state.v2.toFixed(1);
            document.getElementById('rep_ke').innerText = diff.toFixed(1) + " J";

            let valid = true;
            if (diff > 1) {
                badge.innerText = "IMPOSSIBLE"; badge.className = "px-4 py-2 rounded-lg text-xs font-bold bg-red-900/50 text-red-300 border border-red-800";
                note.innerText = "VIOLATION: CREATED ENERGY"; note.className = "text-[10px] text-red-500 text-right uppercase tracking-wider font-bold";
                energyBar.className = "h-full bg-red-500 w-full"; valid = false;
            } else {
                badge.innerText = "PHYSICALLY VALID"; badge.className = "px-4 py-2 rounded-lg text-xs font-bold bg-green-900/50 text-green-300 border border-green-800";
                note.innerText = "ENERGY CONSERVED / LOST"; note.className = "text-[10px] text-green-500 text-right uppercase tracking-wider font-bold";
                energyBar.className = "h-full bg-green-500 w-full";
            }

            if (state.mode === 'sim') {
                log.innerHTML = `<div class="mb-3 text-xs uppercase tracking-widest text-gray-500 font-bold">Simulation Mode</div><div class="mb-4 text-sm"><span class="text-orange-400 font-bold">Target V1:</span> ${state.v1_target} m/s</div><div class="p-4 bg-gray-900 rounded border border-gray-700"><div class="text-xs text-gray-400 mb-2">Calculating V2 via Momentum Conservation:</div><div class="fraction my-3 text-lg"><span class="num">m<sub>1</sub>u<sub>1</sub> + m<sub>2</sub>u<sub>2</sub> - m<sub>1</sub>v<sub>1</sub></span><span class="den">m<sub>2</sub></span></div><div class="mt-3 pt-3 border-t border-gray-700 flex justify-between items-center"><span class="text-gray-400 text-xs">Result V2</span><span class="text-green-400 font-bold font-mono text-lg">${state.v2.toFixed(2)} m/s</span></div></div>`;
            } else {
                const frac = (n, d) => `<div class="fraction"><span class="num">${n}</span><span class="den">${d}</span></div>`;
                let eq = "";
                if(state.unknown === 'v2') eq = `v<sub>2</sub> = ${frac(`m<sub>1</sub>u<sub>1</sub> + m<sub>2</sub>u<sub>2</sub> - m<sub>1</sub>v<sub>1</sub>`,`m<sub>2</sub>`)}`;
                else if(state.unknown === 'v1') eq = `v<sub>1</sub> = ${frac(`m<sub>1</sub>u<sub>1</sub> + m<sub>2</sub>u<sub>2</sub> - m<sub>2</sub>v<sub>2</sub>`,`m<sub>1</sub>`)}`;
                else eq = "Solved via Conservation of Momentum";
                log.innerHTML = `<div class="mb-3 text-xs uppercase tracking-widest text-gray-500 font-bold">Solver Mode</div><div class="mb-4"><span class="text-amber-500 font-bold">Solving For:</span> ${state.unknown.toUpperCase()}</div><div class="p-4 bg-gray-900 rounded border border-gray-700"><div class="my-3 text-lg">${eq}</div><div class="mt-3 pt-3 border-t border-gray-700 flex justify-between items-center"><span class="text-gray-400 text-xs">Calculated Result</span><span class="text-amber-400 font-bold font-mono text-lg">${state[state.unknown].toFixed(2)}</span></div></div>`;
            }
            setTimeout(() => { document.getElementById('reportPanel').style.transform = "translateY(0)"; }, 100);
        }

        // --- Visuals ---
        function spawnExplosion(x, y) { for(let i=0; i<30; i++) state.particles.push({x:x, y:y, vx:(Math.random()-0.5)*300, vy:(Math.random()-0.5)*300, life:1.0, color:`hsl(${Math.random()*60+10},100%,50%)`}); }
        function updateParticles(dt) { for(let i=state.particles.length-1; i>=0; i--) { state.particles[i].x += state.particles[i].vx*dt; state.particles[i].y += state.particles[i].vy*dt; state.particles[i].life -= dt*1.5; if(state.particles[i].life<=0) state.particles.splice(i,1); } }
        function draw() {
            ctx.fillStyle = '#111827'; ctx.fillRect(0, 0, canvas.width, canvas.height); drawRoad();
            const cx = canvas.width/2; 
            
            // Determine facing direction based on velocity (default to Right/1 if stopped)
            const dir1 = state.currV1 < -0.1 ? -1 : 1;
            const dir2 = state.currV2 < -0.1 ? -1 : 1;

            drawCar(cx+state.x1*state.scale, state.offsetY, state.m1, '#3b82f6', 1, dir1); 
            drawCar(cx+state.x2*state.scale, state.offsetY, state.m2, '#ef4444', 2, dir2);
            
            state.particles.forEach(p=>{ctx.globalAlpha=p.life;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,4,0,Math.PI*2);ctx.fill();}); ctx.globalAlpha=1;
        }
        function drawRoad() {
            const y = state.offsetY; ctx.fillStyle='#064e3b'; ctx.fillRect(0, y-100, canvas.width, 200); ctx.fillStyle='#374151'; ctx.fillRect(0, y-60, canvas.width, 120);
            ctx.fillStyle='#9ca3af'; ctx.fillRect(0, y-60, canvas.width, 4); ctx.fillRect(0, y+56, canvas.width, 4);
            ctx.beginPath(); ctx.setLineDash([40, 40]); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.strokeStyle='#9ca3af'; ctx.lineWidth=4; ctx.stroke(); ctx.setLineDash([]);
        }
        function drawCar(x, groundY, mass, color, type, dir) {
            ctx.save(); 
            ctx.translate(x, groundY);
            
            let massFactor = Math.min(Math.max(mass, 500), 5000); 
            const sizeScale = 1 + (massFactor - 1000) / 4000; 
            
            // Apply scale and direction flip
            ctx.scale(dir * sizeScale, sizeScale);
            
            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.5)'; 
            ctx.beginPath(); 
            ctx.ellipse(0, 15, 50, 10, 0, 0, Math.PI*2); 
            ctx.fill();
            
            // Car Body
            ctx.fillStyle = color;
            if (type === 1) { 
                // Sporty Car (Facing Right)
                ctx.beginPath(); 
                ctx.moveTo(-50, 10); 
                ctx.lineTo(50, 10); 
                ctx.lineTo(50, -10); 
                ctx.quadraticCurveTo(20, -10, 10, -25); 
                ctx.lineTo(-20, -25); 
                ctx.quadraticCurveTo(-40, -10, -50, -10); 
                ctx.closePath(); 
                ctx.fill();
                // Stripe
                ctx.fillStyle = 'rgba(255,255,255,0.2)'; 
                ctx.fillRect(-20, -20, 40, 2);
            } else { 
                // Truck (Facing Right)
                // Main Chassis
                ctx.beginPath(); 
                ctx.roundRect(-50, -10, 100, 30, 4); 
                ctx.fill();
                
                // Cab (Shifted to Right side for Front)
                ctx.beginPath(); 
                ctx.roundRect(-10, -30, 55, 20, 4); 
                ctx.fill();
                
                // Truck Bed Railing (Left side)
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.fillRect(-45, -15, 35, 5);

                // Window (On the Cab/Right)
                ctx.fillStyle = '#a5f3fc'; 
                ctx.fillRect(5, -25, 30, 12);
            }
            
            // Wheels (Symmetric)
            ctx.fillStyle = '#111827'; 
            ctx.beginPath(); ctx.arc(-30, 15, 10, 0, Math.PI*2); ctx.arc(30, 15, 10, 0, Math.PI*2); ctx.fill();
            
            // Hubcaps
            ctx.fillStyle = '#6b7280'; 
            ctx.beginPath(); ctx.arc(-30, 15, 4, 0, Math.PI*2); ctx.arc(30, 15, 4, 0, Math.PI*2); ctx.fill();
            
            ctx.restore();
        }
        function updateHUD() {
            const p1 = state.m1 * state.currV1; const p2 = state.m2 * state.currV2;
            document.getElementById('hud_p1').innerText = Math.abs(p1).toFixed(0); document.getElementById('hud_p2').innerText = Math.abs(p2).toFixed(0);
        }

        window.onload = init;
    </script>
</body>
</html>
